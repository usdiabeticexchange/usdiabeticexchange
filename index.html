<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" crossorigin src="./assets/index-BGoGBgGF.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-BQIE1QGu.css">
</head>

<body>
  <div id="root"></div>
<!-- Price sync from Google Sheets -->
<script>
(() => {
  // 1) Your published CSV
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKyuGyVeB6_EMydb8kxP0wiZXyxVFsaaNiM0w6yMj5w4tGomMNWn6glhqlfDJd1laA583L1EL91ZA3/pub?output=csv';

  // 2) Map your dropdown labels -> sheet columns
  const EXP_MAP = {
    '9+ months until expiration': 'price_9plus',
    '9 months until expiration':  'price_9plus',
    '7-8 months until expiration': 'price_7to8',
    '6 months until expiration':   'price_6',
  };

  // 3) Optional aliases if a card title on the site differs from the sheet
  //    LEFT = what the card shows, RIGHT = exact sheet name
  const ALIAS = {
    // 'Contour Next EZ 50 Ct.': 'Contour Next EZ 50 Ct.',
    // 'MMT-242': 'MMT 242',
  };

  // ---------- helpers ----------
  const norm = s => (s || '').toLowerCase().replace(/[–—]/g,'-').replace(/\s+/g, ' ').trim();
  const fmt  = n => '$' + Number(n).toFixed(2);
  const toNum = v => {
    const n = Number(String(v ?? '').replace(/[^\d.]/g,''));
    return Number.isFinite(n) ? n : null;
  };

  function findNameEl(card) {
    return card.querySelector('[data-product-name], .product-name, .card-title, h3, h4, .title');
  }
  function findPriceEl(card) {
    const cands = card.querySelectorAll(
      '[data-price], .price, .product-price, .price-value, .text-success, .text-green-600, .text-green-700, [class*="text-green"]'
    );
    for (const el of cands) {
      if (/\$\s*\d/.test((el.textContent || ''))) return el; // prefer an existing price node
    }
    return cands[0] || null;
  }
  function getSelect(card) {
    return card.querySelector('select');
  }

  // Overwrite price text (prevents "$30.0030.00") and keep it green/bold
  function setPriceKeepingStyle(el, value) {
    if (!el) return;
    el.textContent = fmt(value); // overwrite ALL text
    try {
      const cls = el.classList;
      const hasGreen = Array.from(cls).some(c => c === 'text-success' || c.startsWith('text-green'));
      if (!hasGreen) cls.add('text-green-600', 'font-semibold');
    } catch {}
  }

  function buildIndex(rows) {
    const map = new Map();
    for (const r of rows) {
      const name = norm(r.name || r.Name || r.product || r.Product);
      if (!name) continue;
      map.set(name, {
        price_9plus: toNum(r.price_9plus ?? r['9+'] ?? r['9_plus'] ?? r['9 mo']),
        price_7to8:  toNum(r.price_7to8  ?? r['7-8'] ?? r['7_to_8'] ?? r['7-8 mo']),
        price_6:     toNum(r.price_6     ?? r['6']   ?? r['6 mo']),
      });
    }
    return map;
  }

  function sheetKeyForCardTitle(title) {
    const visible = (title || '').trim();
    const alias = ALIAS[visible] || visible;
    return norm(alias);
  }

  function labelFor(sel) {
    const opt = sel?.options?.[sel.selectedIndex];
    return (opt ? opt.textContent : '').trim() || '9+ months until expiration';
  }

  function applyOne(map, card) {
    const nameEl  = findNameEl(card);
    const priceEl = findPriceEl(card);
    if (!nameEl || !priceEl) return false;

    const key = sheetKeyForCardTitle(nameEl.textContent);
    const row = map.get(key);
    if (!row) { card.dataset.priceSyncMissing = '1'; return false; }

    const sel   = getSelect(card);
    const label = labelFor(sel);
    const col   = EXP_MAP[label] || 'price_9plus';
    const val   = row[col] ?? row.price_9plus;
    if (val == null) return false;

    setPriceKeepingStyle(priceEl, val);

    if (sel && !sel.dataset.priceSyncBound) {
      sel.addEventListener('change', () => applyOne(map, card));
      sel.dataset.priceSyncBound = '1';
    }
    return true;
  }

  function findAllCards() {
    // Start from “Add to Sale” buttons and climb to the card container
    const btns = [...document.querySelectorAll('button')].filter(b =>
      /add to sale/i.test(b.textContent || '')
    );
    const cards = [];
    for (const b of btns) {
      let el = b.closest('[data-product-card], .product-card, .card, .bg-white') || b.parentElement;
      for (let i = 0; i < 8 && el; i++) {
        if (findNameEl(el) && findPriceEl(el) && getSelect(el)) break;
        el = el.parentElement;
      }
      if (el && !cards.includes(el)) cards.push(el);
    }
    return cards;
  }

  function hydrate(rows) {
    const map = buildIndex(rows);
    const applyAll = () => {
      const cards = findAllCards();
      for (const c of cards) applyOne(map, c);
    };
    applyAll();
    // Re-apply on tab/list changes
    const mo = new MutationObserver(applyAll);
    mo.observe(document.body, { childList: true, subtree: true });
  }

  async function fetchCSV() {
    const res = await fetch(CSV_URL + '&cb=' + Date.now(), { mode: 'cors' });
    const txt = await res.text();
    // Tiny CSV -> objects (sheet has no quoted commas in names)
    const lines = txt.trim().split(/\r?\n/);
    const hdr = lines.shift().split(',').map(h => h.trim());
    return lines.map(line => {
      const cols = line.split(',');
      const o = {};
      hdr.forEach((h, i) => o[h] = cols[i] ?? '');
      return o;
    });
  }

  if (window.__priceSyncAttached) return;
  window.__priceSyncAttached = true;

  function start() {
    // Wait for SPA to render cards
    let tries = 0, max = 10;
    const tick = async () => {
      const ready = findAllCards().length > 0;
      if (!ready && tries++ < max) return void setTimeout(tick, 800);
      const rows = await fetchCSV();
      hydrate(rows);
    };
    tick();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
})();
</script>








</body>

</html>
