<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" crossorigin src="./assets/index-BGoGBgGF.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-BQIE1QGu.css">
</head>

<body>
  <div id="root"></div>
<!-- Price sync from Google Sheets (preserves green styling) -->
<script>
(() => {
  // Your published CSV
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKyuGyVeB6_EMydb8kxP0wiZXyxVFsaaNiM0w6yMj5w4tGomMNWn6glhqlfDJd1laA583L1EL91ZA3/pub?output=csv';

  // Map the dropdown labels -> sheet columns
  const EXP_MAP = {
    '9+ months until expiration': 'price_9plus',
    '9 months until expiration':  'price_9plus',   // variant seen on your UI
    '7-8 months until expiration': 'price_7to8',
    '6 months until expiration':   'price_6',
  };

  // Optional aliases: LEFT = what the card shows, RIGHT = sheet product_name (or product_key)
  // Add pairs here if any card title is quirky.
  const ALIAS = {
    // 'OneTouch Ultra 50 Ct.': 'OneTouch Ultra 50 Ct.',
  };

  // ---------- helpers ----------
  const norm = s => (s || '').toLowerCase().replace(/\s+/g, ' ').trim();
  const slug = s => (s || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g,'');
  const toNum = v => {
    const n = Number(String(v ?? '').replace(/[^\d.]/g, ''));
    return Number.isFinite(n) ? n : null;
  };
  const fmt = n => '$' + Number(n).toFixed(2);

  function findNameEl(card) {
    return card.querySelector('[data-product-name], .product-name, .card-title, h3, h4, .title');
  }
  function findPriceEl(card) {
    // Prefer an existing price element (to keep green classes)
    const cands = card.querySelectorAll(
      '[data-price], .price, .product-price, .price-value, .text-success, .text-green, [class*="text-green"]'
    );
    for (const el of cands) {
      if (/\$\s*\d/.test((el.textContent || '').trim())) return el;
    }
    return cands[0] || null;
  }
  function labelFor(sel) {
    const opt = sel?.options?.[sel.selectedIndex];
    return (opt ? opt.textContent : '').trim() || '9+ months until expiration';
  }
  function setPriceText(el, value) {
    if (!el) return;
    const txt = fmt(value);
    // Update only the text node so we donâ€™t drop classes/styles
    let t = Array.from(el.childNodes || []).find(n => n.nodeType === 3);
    if (!t) { t = document.createTextNode(''); el.appendChild(t); }
    t.textContent = txt;

    // If the element isn't already green, add a safe green class
    try {
      const cls = el.classList;
      const hasGreen = Array.from(cls).some(c => c.includes('text-green') || c === 'text-success');
      if (!hasGreen) cls.add('text-green-600', 'font-semibold');
    } catch {}
  }

  // Build a lookup map keyed by normalized product_name AND by product_key
  function buildMap(rows) {
    const map = new Map();
    rows.forEach(r => {
      // Read both product_name and product_key
      const name = r.product_name ?? r.name ?? r.product ?? r.Product ?? r.Name;
      const key  = r.product_key;
      const kName = norm(name);
      const kSlug = slug(key);

      const rowObj = {
        product_name: name,
        product_key: key,
        price_9plus: toNum(r.price_9plus ?? r['9+ months until expiration'] ?? r['9+'] ?? r['9_plus']),
        price_7to8:  toNum(r.price_7to8  ?? r['7-8 months until expiration'] ?? r['7-8']),
        price_6:     toNum(r.price_6     ?? r['6 months until expiration']   ?? r['6']),
      };

      if (kName) map.set(`name::${kName}`, rowObj);
      if (kSlug) map.set(`key::${kSlug}`, rowObj);
    });
    return map;
  }

  // Find all product cards (robust: start from the "Add to Sale" buttons)
  function findAllCards() {
    const btns = [...document.querySelectorAll('button')].filter(b => /add to sale/i.test(b.textContent || ''));
    const cards = [];
    for (const btn of btns) {
      let el = btn.closest('[data-product-card], .product-card, .card, .bg-white') || btn.parentElement;
      for (let i = 0; i < 8 && el; i++) {
        const nameEl = findNameEl(el);
        const priceEl = findPriceEl(el);
        const sel = el.querySelector('select');
        if (nameEl && priceEl && sel) break;
        el = el.parentElement;
      }
      if (el && !cards.includes(el)) cards.push(el);
    }
    return cards;
  }

  function findRowForCard(map, card) {
    const nameEl = findNameEl(card);
    if (!nameEl) return null;

    const visible = (nameEl.textContent || '').trim();
    // 1) direct alias
    const aliased = ALIAS[visible] || visible;

    // 2) lookup by product_name (normalized)
    const byName = map.get(`name::${norm(aliased)}`);
    if (byName) return byName;

    // 3) lookup by a slugified key derived from the title (works if your sheet has product_key)
    const guessKey = slug(aliased);
    const byKey = map.get(`key::${guessKey}`);
    if (byKey) return byKey;

    // 4) last-resort loose match: strip common suffixes like "Ct.", "Pack", etc.
    const loose = norm(aliased).replace(/\b(ct|count|pack|packs|box|boxes)\b\.?/g,'').replace(/\s+/g,' ').trim();
    return map.get(`name::${loose}`) || map.get(`key::${slug(loose)}`) || null;
  }

  function applyPriceToCard(map, card) {
    const priceEl = findPriceEl(card);
    if (!priceEl) return;

    const sel = card.querySelector('select');
    const label = labelFor(sel);
    const col   = EXP_MAP[label] || 'price_9plus';

    const row = findRowForCard(map, card);
    if (!row) { card.dataset.priceSyncMissing = '1'; return; }

    const val = row[col] ?? row.price_9plus;
    if (val == null) return;

    setPriceText(priceEl, val);

    if (sel && !sel.dataset.boundPriceSync) {
      sel.addEventListener('change', () => applyPriceToCard(map, card));
      sel.dataset.boundPriceSync = '1';
    }
  }

  function hydrate(rows) {
    const map = buildMap(rows);
    const runAll = () => findAllCards().forEach(c => applyPriceToCard(map, c));
    runAll();

    // Watch for SPA updates (tabs, infinite lists, etc.)
    const mo = new MutationObserver(runAll);
    mo.observe(document.body, { childList: true, subtree: true });

    // small console breadcrumb
    const changed = document.querySelectorAll('[data-price-sync-missing]').length ? 0 : findAllCards().length;
    console.log('[price-sync] applied to', findAllCards().length, 'cards');
  }

  function start() {
    function run() {
      Papa.parse(CSV_URL + '&cb=' + Date.now(), {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: res => hydrate(res.data),
        error: err => console.error('[price-sync] CSV load error', err),
      });
    }
    if (typeof Papa === 'undefined') {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
      s.onload = run;
      s.onerror = () => console.error('[price-sync] Failed to load PapaParse');
      document.head.appendChild(s);
    } else {
      run();
    }
  }

  console.log('[price-sync] inline script loaded');
  start();
})();
</script>






</body>

</html>
