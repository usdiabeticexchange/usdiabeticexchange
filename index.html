<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" crossorigin src="./assets/index-BGoGBgGF.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-BQIE1QGu.css">
</head>

<body>
  <div id="root"></div>
<!-- Price sync from Google Sheets (preserves styling) -->
<script>
(() => {
  const CSV_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKyuGyVeB6_EMydb8kxP0wiZXyxVFsaaNiM0w6yMj5w4tGomMNWn6glhqlfDJd1laA583L1EL91ZA3/pub?output=csv';

  // Map dropdown text -> sheet column
  const EXP_MAP = {
    '9+ months until expiration': 'price_9plus',
    '9 months until expiration':  'price_9plus',
    '7-8 months until expiration': 'price_7to8',
    '6 months until expiration':   'price_6',
  };

  // Optional title fixes if a card label differs from sheet “name”
  const ALIAS = {
    // 'OneTouch Ultra 50 Ct.': 'OneTouch Ultra 50 Ct.',
  };

  // ---------- helpers ----------
  const norm = s => (s || '').toLowerCase().replace(/\s+/g, ' ').trim();
  const toNum = v => {
    const n = Number(String(v ?? '').replace(/[^\d.]/g, ''));
    return Number.isFinite(n) ? n : null;
  };
  const fmt = n => '$' + Number(n).toFixed(2);

  // Find parts of a card (be liberal with selectors)
  function findNameEl(card) {
    return card.querySelector('[data-product-name], .product-name, .card-title, h3, h4, .title');
  }
  function findPriceEl(card) {
    // prefer an element that already looks like the price
    const cands = card.querySelectorAll(
      '[data-price], .price, .product-price, .price-value, .text-success, .text-green-600, .text-green-700, [class*="text-green"]'
    );
    for (const el of cands) {
      if (/\$\s*\d/.test((el.textContent||'').trim())) return el;
    }
    return cands[0] || null;
  }
  function findSelect(card) {
    // some builds render a real <select>, some a custom component — if none, default to 9+
    return card.querySelector('select');
  }
  function currentLabel(sel) {
    const t = sel?.options?.[sel.selectedIndex]?.textContent?.trim();
    return t || '9+ months until expiration';
  }
  function setPriceKeepingStyle(el, value) {
    if (!el) return;
    const text = fmt(value);
    // Replace only the text node so classes remain intact
    let tn = Array.from(el.childNodes||[]).find(n => n.nodeType === 3);
    if (!tn) { tn = document.createTextNode(''); el.appendChild(tn); }
    tn.textContent = text;

    // Ensure green if it wasn't already greenish
    try {
      const cls = el.classList;
      const hasGreen = Array.from(cls).some(c => c === 'text-success' || c.startsWith('text-green'));
      if (!hasGreen) cls.add('text-green-600','font-semibold');
    } catch {}
  }

  // Find all cards by walking up from the “Add to Sale” buttons
  function findAllCards() {
    const btns = [...document.querySelectorAll('button')].filter(b => /add to sale/i.test(b.textContent||''));
    const cards = [];
    for (const b of btns) {
      let root = b.closest('[data-product-card], .product-card, .bg-white, .card') || b.parentElement;
      // climb a few levels until we see name/price/select together
      for (let i=0; i<8 && root; i++) {
        if (findNameEl(root) && (findPriceEl(root) || root.querySelector('[class*="text-green"]')) ) break;
        root = root.parentElement;
      }
      if (root && !cards.includes(root)) cards.push(root);
    }
    return cards;
  }

  // Build lookup from CSV rows
  function buildMap(rows) {
    const map = new Map();
    rows.forEach(r => {
      const key = norm(r.name || r.Name || r.product || r.Product);
      if (!key) return;
      map.set(key, {
        price_9plus: toNum(r.price_9plus ?? r['9+'] ?? r['9_plus'] ?? r['9 mo']),
        price_7to8:  toNum(r.price_7to8  ?? r['7-8'] ?? r['7_to_8'] ?? r['7-8 mo']),
        price_6:     toNum(r.price_6     ?? r['6']   ?? r['6 mo']),
      });
    });
    return map;
  }

  function rowForCard(map, card) {
    const nameEl = findNameEl(card);
    if (!nameEl) return null;
    const visible = (nameEl.textContent||'').trim();
    const sheetKey = ALIAS[visible] || visible;
    return map.get(norm(sheetKey)) || null;
  }

  function applyToCard(map, card) {
    const priceEl = findPriceEl(card);
    if (!priceEl) return false;

    const sel = findSelect(card);
    const label = currentLabel(sel);
    const col = EXP_MAP[label] || 'price_9plus';

    const row = rowForCard(map, card);
    if (!row) { card.dataset.priceSyncMissing = '1'; return false; }

    const val = row[col] ?? row.price_9plus;
    if (val == null) return false;

    setPriceKeepingStyle(priceEl, val);

    if (sel && !sel.dataset.boundPriceSync) {
      sel.addEventListener('change', () => applyToCard(map, card));
      sel.dataset.boundPriceSync = '1';
    }
    return true;
  }

  function runWith(rows) {
    const map = buildMap(rows);
    const applyAll = () => {
      const cards = findAllCards();
      let changed = 0;
      cards.forEach(c => { if (applyToCard(map, c)) changed++; });
      console.log('[price-sync] applied to', cards.length, 'cards; changed', changed, 'prices');
    };
    // initial + react/route updates
    applyAll();
    const mo = new MutationObserver(() => applyAll());
    mo.observe(document.body, { childList: true, subtree: true });
  }

  // PapaParse loader (handles commas safely)
  function start() {
    function fetchSheet() {
      Papa.parse(CSV_URL + '&cb=' + Date.now(), {
        download: true, header: true, skipEmptyLines: true,
        complete: res => runWith(res.data),
        error: err => console.error('[price-sync] CSV load error', err)
      });
    }
    // wait for cards to exist, then fetch
    let tries = 0;
    const maxTries = 20;
    const tick = () => {
      if (findAllCards().length) { fetchSheet(); return; }
      if (tries++ < maxTries) setTimeout(tick, 500);
      else fetchSheet(); // fetch anyway; observer will catch later renders
    };
    tick();
  }

  // load Papa if needed, then start
  if (typeof Papa === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
    s.onload = start;
    s.onerror = () => console.error('[price-sync] Failed to load PapaParse');
    document.head.appendChild(s);
  } else {
    start();
  }
})();
</script>






</body>

</html>
