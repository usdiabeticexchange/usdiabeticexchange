<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" crossorigin src="./assets/index-BGoGBgGF.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-BQIE1QGu.css">
</head>

<body>
  <div id="root"></div>
  <!-- Price sync from Google Sheets (runs on any route that has product cards) -->
<script>
(() => {
  // 1) Your published CSV (keep this URL)
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKyuGyVeB6_EMydb8kxP0wiZXyxVFsaaNiM0w6yMj5w4tGomMNWn6glhqlfDJd1laA583L1EL91ZA3/pub?output=csv';

  // 2) Map the dropdown labels on site -> sheet columns
  const EXP_MAP = {
    '9+ months until expiration': 'price_9plus',
    '9 months until expiration':  'price_9plus',  // safety
    '7-8 months until expiration':'price_7to8',
    '6 months until expiration':  'price_6',
  };

  // 3) Optional name fixes (left = what the card shows, right = exact sheet name)
  const ALIAS = {
    // 'MMT-242': 'MMT-242', // example if you ever need to remap display text -> sheet name
  };

  // --- helpers ---
  const norm = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();
  const toNum = v => {
    const n = Number(String(v ?? '').replace(/[^0-9.]/g,''));
    return Number.isFinite(n) ? n : 0;
  };
  const fmt = n => '$' + Number(n).toFixed(2);

  function findNameEl(card){
    return card.querySelector('[data-product-name], .product-name, .card-title, h3, h4, .title');
  }
  function findPriceEl(card){
    // Most sites will match one of these
    return card.querySelector('[data-price], .price, .product-price, .price-value, .text-success, .text-green');
  }
  function findSelectEl(card){
    return card.querySelector('select');
  }
  function getCardSheetKey(nameEl){
    const visible = nameEl.textContent.trim();
    const alias   = nameEl.dataset?.alias || ALIAS[visible] || visible;
    return norm(alias);
  }

  function applyPrice(card, map){
    const nameEl = findNameEl(card);
    const priceEl = findPriceEl(card);
    if(!nameEl || !priceEl) return;

    const key = getCardSheetKey(nameEl);
    const row = map.get(key);
    if(!row){ card.dataset.priceSyncMissing = '1'; return; }

    // Which expiration period is selected?
    const sel = findSelectEl(card);
    let label = '9+ months until expiration';
    if (sel && sel.options.length) {
      label = sel.options[sel.selectedIndex].text.trim();
      // Your dropdown texts look like: "9+ months until expiration - $35"
      // Keep only the part before " - "
      label = label.split(' - ')[0].trim();
    }
    const col = EXP_MAP[label] || 'price_9plus';
    const val = row[col] ?? row['price_9plus'];

    // Update the UI
    priceEl.textContent = fmt(val);

    if (sel && !sel.dataset.bound){
      sel.addEventListener('change', () => applyPrice(card, map));
      sel.dataset.bound = '1';
    }
  }

  function hydrate(csvRows){
    // Build a lookup by normalized name
    const map = new Map();
    csvRows.forEach(r => {
      const name = norm(r.name || r.Name || r.product || r.Product);
      if(!name) return;
      map.set(name, {
        price_9plus: toNum(r.price_9plus ?? r['9+'] ?? r['9_plus'] ?? r['9mo']),
        price_7to8:  toNum(r.price_7to8  ?? r['7-8'] ?? r['7_8']  ?? r['7-8']),
        price_6:     toNum(r.price_6     ?? r['6']   ?? r['6m']   ?? r['6mo']),
      });
    });

    const run = () => document
      .querySelectorAll('[data-product-card], .product-card, .card')
      .forEach(card => applyPrice(card, map));

    run();

    // Re-apply when your SPA swaps content
    const mo = new MutationObserver(run);
    mo.observe(document.body, { childList:true, subtree:true });

    // Debug: count misses in DevTools if needed
    // console.log('[price-sync] missing matches:', document.querySelectorAll('[data-price-sync-missing]').length);
  }

  function start(){
    Papa.parse(CSV_URL + '&_cb=' + Date.now(), {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete: res => hydrate(res.data),
      error: err => console.error('[price-sync] CSV load error', err),
    });
  }

  // Load PapaParse if needed, then go
  if (typeof Papa === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
    s.onload = start;
    s.onerror = () => console.error('[price-sync] Failed to load PapaParse');
    document.head.appendChild(s);
  } else {
    start();
  }
})();
</script>


</body>

</html>
