<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" crossorigin src="./assets/index-BGoGBgGF.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-BQIE1QGu.css">
</head>

<body>
  <div id="root"></div>
<script>
(() => {
  // ---- Guard to avoid duplicates
  if (window.__PS_STABLE__) return; window.__PS_STABLE__ = true;
  console.log('[ps-stable] starting');

  // ---- CONFIG
  const CSV_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKyuGyVeB6_EMydb8kxP0wiZXyxVFsaaNiM0w6yMj5w4tGomMNWn6glhqlfDJd1laA583L1EL91ZA3/pub?output=csv';

  const labelToCol = (label) =>
    /\b6\s*months?/i.test(label)       ? 'p6'  :
    /\b7\s*[-–]?\s*8|\b7-8/.test(label) ? 'p78' : 'p9';

  const ALIAS = {
    // 'Example Variant Name': 'Exact Sheet Name',
  };

  // ---- helpers
  const fmt   = n => '$' + Number(n).toFixed(2);
  const toNum = v => { const n = Number(String(v ?? '').replace(/[^\d.]/g,'')); return Number.isFinite(n)?n:null; };
  const norm  = s => (s||'').toLowerCase().replace(/™|®/g,'').replace(/[^a-z0-9]+/g,' ').replace(/\s+/g,' ').trim();
  const baseLabel = txt => String(txt||'').replace(/\s*-\s*\$[\d.,]+$/,'').trim();

  // ---- sheet index
  let IDX = null; // Map<name,{p9,p78,p6}>
  function buildIndex(rows){
    const map = new Map();
    for (const r of rows){
      const name = r.product_name || r.Product_Name || r.name || r.Name || r.product || r.Product;
      if (!name) continue;
      const key = norm(name);
      map.set(key, {
        p9:  toNum(r['9+ months until expiration'] ?? r['9 months until expiration'] ?? r.price_9plus ?? r['9+'] ?? r['9_plus'] ?? r['9 mo']),
        p78: toNum(r['7-8 months until expiration'] ?? r.price_7to8 ?? r['7-8'] ?? r['7_to_8'] ?? r['7-8 mo']),
        p6:  toNum(r['6 months until expiration']   ?? r.price_6     ?? r['6']   ?? r['6 mo']),
      });
    }
    console.log('[ps-stable] sheet rows indexed:', map.size);
    return map;
  }
  function resolveRow(visible){
    if (!IDX) return null;
    const key = norm(ALIAS[visible] || visible);
    if (IDX.has(key)) return IDX.get(key);
    // fuzzy fallback
    const tokens = key.split(' ').filter(Boolean);
    let bestK=null, score=-1;
    for (const k of IDX.keys()){
      let s=0;
      for (const t of tokens){ if (k.includes(t)) { s+=1; if (/^\d+$/.test(t)) s+=0.75; if (t.length>=5) s+=0.25; } }
      if (s>score){ score=s; bestK=k; }
    }
    return score>=2 ? IDX.get(bestK) : null;
  }

  // ---- DOM finders
  const addToSaleButtons = () => [...document.querySelectorAll('button')].filter(b => /add to sale/i.test(b.textContent||''));
  const findCards = () => {
    const btns = addToSaleButtons(), out = [];
    for (const b of btns){
      let root = b.closest('[data-product-card], .product-card, .bg-white, .card') || b.parentElement;
      for (let i=0;i<8 && root;i++){
        if (getNameEl(root) && root.querySelector('select')) break;
        root = root.parentElement;
      }
      if (root && !out.includes(root)) out.push(root);
    }
    return out;
  };
  const getNameEl = c => c.querySelector('[data-product-name], .product-name, .card-title, h3, h4, .title');
  const getPriceEl = c => {
    const els = c.querySelectorAll('[data-price], .price, .product-price, .price-value, .text-success, .text-green-600, .text-green-700, [class*="text-green"]');
    for (const el of els) if (/\$\s*\d/.test((el.textContent||'').trim())) return el;
    return els[0] || null;
  };

  // ---- card updates
  function setGreenPrice(el, val){
    if (!el) return;
    el.textContent = fmt(val);
    try {
      const cls = el.classList;
      const hasGreen = [...cls].some(c => c === 'text-success' || c.startsWith('text-green'));
      if (!hasGreen) cls.add('text-green-600','font-semibold');
    } catch {}
  }
  function rewriteOptionsOnce(card, row){
    const sel = card.querySelector('select');
    if (!sel || sel === document.activeElement || sel.dataset.psRewritten) return;
    for (const opt of sel.options){
      const base = baseLabel(opt.textContent);
      const col  = labelToCol(base);
      const val  = row[col] ?? row.p9;
      if (val != null){
        const next = `${base} - ${fmt(val)}`;
        if (opt.textContent !== next) opt.textContent = next;
      }
    }
    sel.dataset.psRewritten = '1';
  }
  function syncCardPrice(card, row){
    const sel = card.querySelector('select');
    const gre = getPriceEl(card);
    if (!sel || !gre) return;
    const base = baseLabel(sel.options[sel.selectedIndex]?.textContent || '9+ months until expiration');
    const val  = row[labelToCol(base)] ?? row.p9;
    if (val != null) setGreenPrice(gre, val);
  }
  function applyAcrossCards(){
    if (!IDX) return;
    let changed=0;
    for (const c of findCards()){
      const title = (getNameEl(c)?.textContent || '').trim();
      const row = resolveRow(title); if (!row) continue;
      rewriteOptionsOnce(c, row);
      const before = (getPriceEl(c)?.textContent||'').trim();
      syncCardPrice(c, row);
      const after  = (getPriceEl(c)?.textContent||'').trim();
      if (before !== after) changed++;
      const sel = c.querySelector('select');
      if (sel && !sel.dataset.psBound){
        sel.addEventListener('change', () => { rewriteOptionsOnce(c,row); syncCardPrice(c,row); setTimeout(syncCartDrawer,120); });
        sel.dataset.psBound = '1';
      }
    }
    console.log('[ps-stable] cards pass; green changed:', changed);
  }

  // ---- cart sync (visual)
  const cartRoot = () =>
    document.querySelector('[role="dialog"], [aria-modal="true"], [class*="drawer"], [data-cart], .cart');

  const dollarNodes = scope => [...scope.querySelectorAll('*')].filter(n => /\$\s*\d/.test((n.textContent||'').trim()));

  function itemBlocks(){
    const root = cartRoot(); if (!root) return [];
    // heuristic: any line that has “Expiration:” is an item section
    return [...root.querySelectorAll('*')]
      .filter(n => /^Expiration:/i.test((n.textContent||'').trim()))
      .map(n => n.closest('*')).filter(Boolean);
  }
  function itemTitle(el){
    const t = el.querySelector('h1,h2,h3,h4,.title,.font-medium,[data-product-name]');
    return (t ? t.textContent : el.textContent || '').trim();
  }
  function itemLabel(el){
    const m = [...el.querySelectorAll('*')].find(n => /^Expiration:/i.test((n.textContent||'').trim()));
    if (!m) return '9+ months until expiration';
    const txt = (m.textContent||'').split(':').slice(1).join(':').trim();
    if (/9\+/.test(txt)) return '9+ months until expiration';
    if (/7\s*[-–]?\s*8/.test(txt)) return '7-8 months until expiration';
    if (/\b6\b/.test(txt)) return '6 months until expiration';
    return txt;
  }
  function itemQty(el){
    const n = [...el.querySelectorAll('input, span, div')]
      .find(n => /^\d+$/.test((n.value ?? n.textContent ?? '').trim()));
    const q = Number((n?.value ?? n?.textContent ?? '1').trim());
    return Number.isFinite(q) && q>0 ? q : 1;
  }
  function syncCartDrawer(){
    if (!IDX) return;
    const root = cartRoot(); if (!root) return;
    const items = itemBlocks(); if (!items.length) return;

    let total = 0, touched=0;
    for (const it of items){
      const row = resolveRow(itemTitle(it)); if (!row) continue;
      const want = (row[labelToCol(itemLabel(it))] ?? row.p9); if (want == null) continue;

      // set all visible dollar spans inside the item to unit price (covers "each" and line price)
      for (const d of dollarNodes(it)) d.textContent = fmt(want);
      total += want * itemQty(it);
      touched++;
    }
    // update totals in drawer
    const all$ = dollarNodes(root);
    // try to find “Total” rows first
    const totals = all$.filter(s => /total\b/i.test(s.closest('*')?.textContent || ''));
    (totals.length ? totals : [all$[all$.length-1]]).forEach(n => n.textContent = fmt(total));

    console.log('[ps-stable] cart synced items:', touched, 'total:', fmt(total));
  }

  // ---- bootstrap
  function tinyParseCSV(txt){
    const lines = txt.split(/\r?\n/).filter(Boolean);
    const hdr = (lines.shift()||'').split(',').map(h=>h.trim());
    return lines.map(line => {
      const cols = line.split(',');
      const o = {}; hdr.forEach((h,i)=> o[h] = (cols[i] ?? '').trim());
      return o;
    });
  }
  function loadSheet(){
    const run = rows => { IDX = buildIndex(rows); applyAcrossCards(); syncCartDrawer(); };
    if (window.Papa){
      Papa.parse(CSV_URL+'&cb='+Date.now(), { download:true, header:true, skipEmptyLines:true,
        complete: res => run(res.data), error: e => console.error('[ps-stable] CSV load error', e) });
    } else {
      fetch(CSV_URL+'&cb='+Date.now())
        .then(r => r.ok ? r.text() : Promise.reject(r.status))
        .then(t => run(tinyParseCSV(t)))
        .catch(e => console.error('[ps-stable] CSV fetch error', e));
    }
  }

  // wait for cards first
  let tries=0; (function wait(){
    if (findCards().length) loadSheet();
    else if (++tries < 60) setTimeout(wait, 150);
    else console.warn('[ps-stable] no cards found');
  })();

  // re-apply on SPA changes
  const root = document.querySelector('#root') || document.body;
  const mo = new MutationObserver(() => {
    clearTimeout(mo.t1); clearTimeout(mo.t2);
    mo.t1 = setTimeout(applyAcrossCards, 80);
    mo.t2 = setTimeout(syncCartDrawer, 160);
  });
  mo.observe(root, { childList:true, subtree:true });

  // re-sync cart after item is added / qty changed
  document.addEventListener('click', e => {
    const b = e.target.closest('button');
    if (b && /add to sale/i.test(b.textContent||'')){
      setTimeout(syncCartDrawer, 250);
      setTimeout(syncCartDrawer, 700);
    }
    if (b && /[-+]/.test(b.textContent||'')) {
      setTimeout(syncCartDrawer, 200);
    }
  });

  // small diagnostic you can run in console
  window.__PS_TEST__ = () => ({ cards: findCards().length, index: IDX?.size, cartItems: itemBlocks().length });
})();
</script>








</body>

</html>
