<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" crossorigin src="./assets/index-BGoGBgGF.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-BQIE1QGu.css">
</head>

<body>
  <div id="root"></div>
 <!-- Price sync from Google Sheets -->
<script>
(() => {
  // 1) Your published CSV (leave as is)
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKyuGyVeB6_EMydb8kxP0wiZXyxVFsaaNiM0w6yMj5w4tGomMNWn6glhqlfDJd1laA583L1EL91ZA3/pub?output=csv';

  // 2) Map dropdown labels to sheet columns
  const EXP_MAP = {
    '9+ months until expiration': 'price_9plus',
    '9+ months until expiration - $35': 'price_9plus',
    '7-8 months until expiration': 'price_7to8',
    '7-8 months until expiration - $35': 'price_7to8',
    '6 months until expiration': 'price_6',
    '6 months until expiration - $35': 'price_6',
  };

  // 3) Optional aliases if any card titles differ from the sheet Product name
  const ALIAS = {
    // 'OneTouch Ultra 50 Ct.': 'OneTouch Ultra 50 Ct.',
    // 'MMT-242': 'MMT-242',
  };

  // --- helpers ---
  const norm = s => (s || '').toLowerCase().replace(/\s+/g,' ').trim();
  const toNum = v => { const n = Number(String(v ?? '').replace(/[^\d.]/g,'')); return Number.isFinite(n) ? n : null; };
  const money = n => '$' + Number(n).toFixed(2);

  const looksLikeMonths = t => /months?\s+until\s+expiration/i.test(t || '');
  const extractLabel = t => {
    if (!t) return null;
    const m = t.match(/(?:9\+\s*months|7-8\s*months|6\s*months)\s+until\s+expiration(?:\s*-\s*\$\d+)?/i);
    return m ? m[0].trim().replace(/\s+/g,' ') : null;
  };

  // Find a product card by “Add to Sale” button, then pick key parts inside it
  const addToSaleButtons = () => [...document.querySelectorAll('button, a')].filter(el => /add to sale/i.test(el.textContent || ''));
  const unique = arr => [...new Set(arr)];
  const guessCard = el =>
    el.closest('[data-product-card], .product-card, .card, .item, .listing, [class*="card"], [class*="product"]')
    || (() => { let p = el; for (let i=0;i<6 && p; i++, p=p.parentElement) { if (p && p.children && p.children.length > 2) return p; } return el; })();

  const findNameEl = card => card.querySelector('[data-product-name], .product-name, .card-title, h3, h4, strong, b, [class*="title"], [class*="name"]');
  const findPriceEl = card => {
    const candSel = [
      '[data-price]','.price','.product-price','.price-value',
      '.text-success','.text-green','[class*="price"]','[class*="success"]'
    ].join(',');
    let el = card.querySelector(candSel);
    if (el) return el;
    // Fallback: any leaf text that looks like $##
    for (const n of card.querySelectorAll('*')) {
      if (!n.childElementCount && /^\s*\$\d/.test((n.textContent||''))) return n;
    }
    return null;
  };

  // Works for native <select> and custom dropdowns
  const getSelectedExpiration = (card) => {
    // Native select?
    const sel = card.querySelector('select');
    if (sel) return (sel.options[sel.selectedIndex]?.text || '').trim();

    // Custom dropdown/button that shows the current selection
    // Look for a clickable element whose text contains “…months until expiration”
    const clicky = [...card.querySelectorAll('button,[role="button"],[aria-haspopup],[class*="select"],[class*="dropdown"]')]
      .find(el => looksLikeMonths(el.textContent));
    if (clicky) {
      const lbl = extractLabel(clicky.textContent);
      if (lbl) return lbl;
    }

    // Fallback: any descendant text with the label
    const any = [...card.querySelectorAll('*')].find(el => looksLikeMonths(el.textContent));
    if (any) {
      const lbl = extractLabel(any.textContent);
      if (lbl) return lbl;
    }

    // Last resort: default band
    return '9+ months until expiration';
  };

  // Google Sheet map: name -> {price_9plus, price_7to8, price_6}
  function buildSheetMap(rows){
    const map = new Map();
    rows.forEach(r => {
      const name = norm(r.name || r.Name || r.product || r.Product || r.product_name);
      if (!name) return;
      map.set(name, {
        price_9plus: toNum(r.price_9plus ?? r['9_+'] ?? r['9_plus'] ?? r['9+']) ,
        price_7to8:  toNum(r.price_7to8  ?? r['7-8'] ?? r['7_8'] ?? r['7 8']) ,
        price_6:     toNum(r.price_6     ?? r['6']   ?? r['6mo'] ?? r['6 mo']),
      });
    });
    return map;
  }

  const sheetKeyForName = visible => {
    const alias = ALIAS[visible] || visible;
    return norm(alias);
  };

  function applyToCard(card, map){
    const nameEl  = findNameEl(card);
    const priceEl = findPriceEl(card);
    if (!nameEl || !priceEl) return;

    const visibleName = (nameEl.textContent || '').trim();
    const key = sheetKeyForName(visibleName);
    const row = map.get(key);
    if (!row) { card.dataset.priceSyncMissing = '1'; return; }

    const selectedLabel = getSelectedExpiration(card);
    const col = EXP_MAP[selectedLabel] || 'price_9plus';
    const val = row[col] ?? row.price_9plus;

    if (val != null) priceEl.textContent = money(val);
  }

  function applyAll(map){
    const cards = unique(addToSaleButtons().map(guessCard));
    cards.forEach(card => applyToCard(card, map));
  }

  // Watch for SPA/nav changes and dropdown changes
  function observe(map){
    const mo = new MutationObserver(() => applyAll(map));
    mo.observe(document.body, { childList:true, subtree:true, characterData:true });
  }

  // Fetch CSV with PapaParse
  function start(){
    Papa.parse(CSV_URL + '&cb=' + Date.now(), {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: res => {
        const map = buildSheetMap(res.data);
        applyAll(map);
        observe(map);
      },
      error: err => console.error('[price-sync] CSV error', err)
    });
  }

  // Lazy-load PapaParse if missing
  if (typeof Papa === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
    s.onload = start;
    s.onerror = () => console.error('[price-sync] Failed to load PapaParse');
    document.head.appendChild(s);
  } else {
    start();
  }
})();
</script>



</body>

</html>
