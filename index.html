<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" crossorigin src="./assets/index-BGoGBgGF.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/index-BQIE1QGu.css">
</head>

<body>
  <div id="root"></div>
<script>
(() => {
  if (window.__PS_V3__) return; window.__PS_V3__ = true;
  console.log('[ps v3] boot');

  /* ================== CONFIG ================== */
  const CSV_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKyuGyVeB6_EMydb8kxP0wiZXyxVFsaaNiM0w6yMj5w4tGomMNWn6glhqlfDJd1laA583L1EL91ZA3/pub?output=csv';

  // Map any visible title -> sheet name if they differ
  const ALIAS = {
    // 'OneTouch Ultra™ 50 Ct.': 'OneTouch Ultra 50 Ct.',
  };

  const labelToCol = (label) =>
    /\b6\s*months?/i.test(label)              ? 'p6'
  : /\b7\s*[-–]?\s*8|\b7-8/i.test(label)      ? 'p78'
  :                                             'p9';

  /* ================== UTILS ================== */
  const fmt   = n => '$' + Number(n).toFixed(2);
  const toNum = v => { const n = Number(String(v ?? '').replace(/[^\d.]/g,'')); return Number.isFinite(n) ? n : null; };
  const norm  = s => (s||'').toLowerCase().replace(/™|®/g,'').replace(/[^a-z0-9]+/g,' ').replace(/\s+/g,' ').trim();
  const baseLabel = txt => String(txt||'').replace(/\s*-\s*\$[\d.,]+$/,'').trim();

  /* ================== SHEET INDEX ================== */
  let INDEX = null; // Map<normalizedName, {p9,p78,p6}>

  function buildIndex(rows){
    const map = new Map();
    for (const r of rows){
      const name = r.product_name || r.Product_Name || r.name || r.Name || r.product || r.Product;
      if (!name) continue;
      const key = norm(name);
      map.set(key, {
        p9:  toNum(r['9+ months until expiration'] ?? r['9 months until expiration'] ?? r.price_9plus ?? r['9+'] ?? r['9_plus'] ?? r['9 mo']),
        p78: toNum(r['7-8 months until expiration'] ?? r.price_7to8 ?? r['7-8'] ?? r['7_to_8'] ?? r['7-8 mo']),
        p6:  toNum(r['6 months until expiration']   ?? r.price_6     ?? r['6']   ?? r['6 mo']),
      });
    }
    console.log('[ps v3] sheet rows indexed:', map.size);
    return map;
  }

  function resolveRow(visibleTitle){
    if (!INDEX) return null;
    const k = norm(ALIAS[visibleTitle] || visibleTitle);
    if (INDEX.has(k)) return INDEX.get(k);

    // fuzzy: token overlap
    const tokens = k.split(' ').filter(Boolean);
    let bestKey = null, bestScore = -1;
    for (const key of INDEX.keys()){
      let s = 0;
      for (const t of tokens){
        if (key.includes(t)){ s += 1; if (/^\d+$/.test(t)) s += 0.75; if (t.length>=5) s += 0.25; }
      }
      if (s > bestScore){ bestScore = s; bestKey = key; }
    }
    return bestScore >= 2 ? INDEX.get(bestKey) : null;
  }

  /* ================== CARD DISCOVERY ================== */
  const looksLikeExpirySelect = (sel) =>
    !![...sel.options].find(o => /\bmonths?\b.*\buntil\b.*\bexpiration\b/i.test(o.textContent || ''));

  function cardRootFrom(el){
    let root = el.closest('[data-product-card], .product-card, .bg-white, .card') || el.parentElement;
    for (let i=0; i<8 && root; i++){
      const hasTitle = root.querySelector('[data-product-name], .product-name, .card-title, h3, h4, .title');
      const hasPrice = root.querySelector('[data-price], .price, .product-price, .price-value, .text-success, [class*="text-green"]');
      if (hasTitle && hasPrice) break;
      root = root.parentElement;
    }
    return root || null;
  }

  function findCards(){
    const set = new Set();

    // by <select>
    document.querySelectorAll('select').forEach(sel => {
      if (!looksLikeExpirySelect(sel)) return;
      const root = cardRootFrom(sel);
      if (root) set.add(root);
    });

    // fallback by Add to Sale button
    document.querySelectorAll('button').forEach(b => {
      if (!/add to sale/i.test(b.textContent || '')) return;
      const root = cardRootFrom(b);
      if (root) set.add(root);
    });

    return [...set];
  }

  const titleEl = c => c.querySelector('[data-product-name], .product-name, .card-title, h3, h4, .title');
  const priceEl = c => {
    const els = c.querySelectorAll('[data-price], .price, .product-price, .price-value, .text-success, .text-green-600, .text-green-700, [class*="text-green"]');
    for (const el of els) if (/\$\s*\d/.test((el.textContent||'').trim())) return el;
    return els[0] || null;
  };

  /* ================== CARD UPDATES ================== */
  function setGreen(el, val){
    if (!el || val == null) return false;
    const before = el.textContent.trim();
    el.textContent = fmt(val);
    try {
      const cls = el.classList;
      const hasGreen = [...cls].some(c => c === 'text-success' || c.startsWith('text-green'));
      if (!hasGreen) cls.add('text-green-600','font-semibold');
    } catch {}
    return before !== el.textContent.trim();
  }

  function rewriteOptions(card, row){
    const sel = card.querySelector('select'); if (!sel) return 0;
    let changed = 0;
    for (const opt of sel.options){
      const base = baseLabel(opt.textContent);
      const col  = labelToCol(base);
      const val  = row[col] ?? row.p9;
      if (val == null) continue;
      opt.dataset.psPrice = String(val);
      const next = `${base} - ${fmt(val)}`;
      if (opt.textContent !== next){ opt.textContent = next; changed++; }
    }
    return changed;
  }

  function selectedPrice(card, row){
    const sel = card.querySelector('select'); if (!sel) return null;
    const opt = sel.options[sel.selectedIndex];
    const stored = toNum(opt?.dataset?.psPrice);
    if (stored != null) return stored; // use our stored price if present
    const base = baseLabel(opt?.textContent || '');
    const col  = labelToCol(base);
    return row[col] ?? row.p9 ?? null;
  }

  function applyToCard(card){
    const title = (titleEl(card)?.textContent || '').trim();
    const row = resolveRow(title);
    if (!row) return { changed:false, opts:0, missing:title };

    const opts = rewriteOptions(card, row);
    const price = selectedPrice(card, row);
    const changed = setGreen(priceEl(card), price);

    // keep green price in sync with dropdown change
    const sel = card.querySelector('select');
    if (sel && !sel.dataset.psBound){
      sel.addEventListener('change', () => {
        const r = resolveRow((titleEl(card)?.textContent || '').trim()) || row;
        setGreen(priceEl(card), selectedPrice(card, r));
      });
      sel.dataset.psBound = '1';
    }
    return { changed, opts, missing:null };
  }

  function applyAll(){
    if (!INDEX) return;
    const cards = findCards();
    let green = 0, options = 0, missing = [];
    for (const c of cards){
      const res = applyToCard(c);
      green   += res.changed ? 1 : 0;
      options += res.opts    || 0;
      if (res.missing) missing.push(res.missing);
    }
    console.log('[ps v3] cards:', cards.length, '| options updated:', options, '| green updated:', green);
    if (missing.length) console.warn('[ps v3] add ALIAS for:', [...new Set(missing)]);
  }

  /* ================== CART SYNC ================== */
  const cartRoot = () =>
    document.querySelector('[role="dialog"], [aria-modal="true"], [class*="drawer"], [data-cart], .cart');

  const dollarNodes = scope =>
    [...scope.querySelectorAll('*')].filter(n => /\$\s*\d/.test((n.textContent||'').trim()));

  function itemBlocks(){
    const root = cartRoot(); if (!root) return [];
    return [...root.querySelectorAll('*')]
      .filter(n => /^Expiration:/i.test((n.textContent||'').trim()))
      .map(n => n.closest('*')).filter(Boolean);
  }
  const itemTitle = el =>
    (el.querySelector('h1,h2,h3,h4,.title,.font-medium,[data-product-name]')?.textContent || el.textContent || '').trim();

  function itemLabel(el){
    const m = [...el.querySelectorAll('*')].find(n => /^Expiration:/i.test((n.textContent||'').trim()));
    const txt = (m?.textContent || '').split(':').slice(1).join(':').trim();
    if (/9\+/.test(txt))                   return '9+ months until expiration';
    if (/7\s*[-–]?\s*8/.test(txt))         return '7-8 months until expiration';
    if (/\b6\b/.test(txt))                 return '6 months until expiration';
    return '9+ months until expiration';
  }
  function itemQty(el){
    const n = [...el.querySelectorAll('input, span, div')].find(n => /^\d+$/.test((n.value ?? n.textContent ?? '').trim()));
    const q = Number((n?.value ?? n?.textContent ?? '1').trim());
    return Number.isFinite(q) && q>0 ? q : 1;
  }

  function syncCart(){
    if (!INDEX) return;
    const root = cartRoot(); if (!root) return;
    const items = itemBlocks(); if (!items.length) return;

    let touched = 0, total = 0;
    for (const it of items){
      const row = resolveRow(itemTitle(it)); if (!row) continue;
      const want = (row[labelToCol(itemLabel(it))] ?? row.p9); if (want == null) continue;

      for (const d of dollarNodes(it)) d.textContent = fmt(want); // set unit price everywhere in the item
      total += want * itemQty(it);
      touched++;
    }
    // update total
    const all$ = dollarNodes(root);
    const totals = all$.filter(s => /total\b/i.test(s.closest('*')?.textContent || ''));
    (totals.length ? totals : [all$[all$.length-1]]).forEach(n => n.textContent = fmt(total));

    if (touched) console.log('[ps v3] cart items synced:', touched, 'total:', fmt(total));
  }

  /* ================== CSV LOAD ================== */
  function parseCSV(txt){
    const lines = txt.split(/\r?\n/);
    if (!lines.length) return [];
    const hdr = (lines.shift()||'').split(',').map(h=>h.trim());
    return lines.filter(Boolean).map(line => {
      // your sheet has no quoted commas, so a simple split is OK
      const cols = line.split(',');
      const o = {}; hdr.forEach((h,i)=> o[h] = (cols[i] ?? '').trim());
      return o;
    });
  }

  function loadSheet(){
    return fetch(CSV_URL + '&cb=' + Date.now())
      .then(r => r.ok ? r.text() : Promise.reject(r.status))
      .then(t => { INDEX = buildIndex(parseCSV(t)); });
  }

  /* ================== BOOT ================== */
  (async function init(){
    // wait until at least 1 card-select is in DOM
    let tries=0;
    await new Promise(resolve => {
      (function w(){
        if (findCards().length) return resolve();
        if (++tries > 60) return resolve();
        setTimeout(w, 150);
      })();
    });

    await loadSheet();
    applyAll();
    syncCart();
  })();

  // keep things fresh for SPA updates
  const root = document.querySelector('#root') || document.body;
  const mo = new MutationObserver(() => {
    clearTimeout(mo.t1); clearTimeout(mo.t2);
    mo.t1 = setTimeout(applyAll, 120);
    mo.t2 = setTimeout(syncCart, 250);
  });
  mo.observe(root, { childList:true, subtree:true });

  // re-sync after adds and qty +/- clicks
  document.addEventListener('click', e => {
    const b = e.target.closest('button');
    if (!b) return;
    const txt = (b.textContent||'').trim();
    if (/add to sale/i.test(txt) || /^[+-]$/.test(txt)) {
      setTimeout(syncCart, 250);
      setTimeout(syncCart, 700);
    }
  });

  // quick console helper
  window.__PS_STATUS__ = () => ({ cards: findCards().length, indexed: INDEX?.size });
})();
</script>



</body>

</html>
